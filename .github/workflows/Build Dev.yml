name: Docker B P 

on:
  # Run workflow on push events to the main branch
  push:
    branches: [ main ]

jobs:
  build-and-push-to-docker:
    runs-on: ubuntu-latest  # Replace with your preferred runner

    steps:
      - name: Checkout code
        uses: actions/checkout@v3  # Fetches code from your repository

      - name: Login to Docker Hub (using secrets)
        uses: docker/login-action@v2  # Official Docker login action
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image (using build args)
        uses: docker/build-push-action@v5  # Official Docker build and push action
        with:
          push: true  # Push image to Docker Hub
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/pg-custom:0.5.0  # Replace with your desired tag
          context: .
          platforms: linux/amd64,linux/arm64
          build-args: |  # Pass environment variables to build process
            POSTGRES_VERSION=15
            PARTMAN_VERSION=4.7.1
          # Include the Dockerfile content directly:
          dockerfile: |
            ARG POSTGRES_VERSION
            ARG PARTMAN_VERSION
            FROM postgres:$POSTGRES_VERSION
            RUN apt-get update && apt-get install unzip && apt-get --assume-yes install build-essential && apt-get --assume-yes install postgresql-server-dev-11 && apt-get install  -y wget \
            && wget https://github.com/keithf4/pg_partman/archive/v$PARTMAN_VERSION.zip -O $PARTMAN_VERSION.zip \
            && unzip $PARTMAN_VERSION.zip \
            && cd /pg_partman-$PARTMAN_VERSION && pwd && make install && make NO_BGW=1 install
